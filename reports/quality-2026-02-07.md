# Code Quality Report: TermChat

**Date**: 2026-02-07
**Commit**: `23e035d` (main)
**Codebase**: 6,690 SLOC across 30 Rust files (3 crates)

---

## Overall Grade: B- (73/100)

| Category | Weight | Grade | Score | Notes |
|----------|--------|-------|-------|-------|
| Architecture | 30% | B | 80 | Clean module structure, no real circular deps, but `pub` over-exposure |
| Code Quality | 30% | C+ | 68 | 53 clippy pedantic warnings, 16 production unwrap/expect, high complexity in 5 modules |
| Dependencies | 20% | C | 62 | 2 unmaintained advisories (bincode, paste), license gaps, 7 duplicate crate versions |
| Wheel Reinvention | 20% | B+ | 85 | Good crate choices overall, minor opportunities |

---

## 1. Architectural Quality: B (80/100)

### Module Structure

```
termchat/src/           (client — 4,568 SLOC)
  app.rs                  State machine, event routing
  ui/                     TUI rendering (ratatui)
  chat/                   Domain: messages, rooms, history
  crypto/                 Noise handshake, key management
  transport/              P2P (QUIC), relay (WS), hybrid

termchat-relay/src/     (server — 1,363 SLOC)
  relay.rs                WebSocket handler, peer routing
  rooms.rs                Room registry
  store.rs                Message queue

termchat-proto/src/     (shared — 994 SLOC)
  message.rs              Wire format types
  codec.rs                Bincode encode/decode
  relay.rs                Relay protocol
  room.rs                 Room protocol
```

**Hexagonal architecture assessment**: Partial. Transport is behind a trait (`Transport`), crypto is behind a trait (`CryptoSession`), and history is behind a trait (`MessageStore`). These are good port abstractions. However, domain types in `chat/` directly depend on transport types, and `app.rs` mixes UI event handling with domain logic. Score: 7/10.

### Circular Dependencies

`cargo-modules --acyclic` reports false positives (enum method self-references like `PanelFocus::eq`). **No real module-level circular dependencies detected.** Score: 10/10.

### Module Boundary Leakage

| Metric | Count |
|--------|-------|
| `pub` items (fn/struct/enum/trait/type) | 54 |
| `pub(crate)` items | 1 |

**Almost everything is `pub` instead of `pub(crate)`.** This means internal implementation details are exposed as public API. For a binary crate this is low-risk, but for `termchat-proto` (a library consumed by other crates) it matters more. Score: 5/10.

---

## 2. Code Quality: C+ (68/100)

### Clippy Analysis (pedantic + nursery)

| Lint | Count | Severity |
|------|-------|----------|
| `doc_markdown` | 20 | Low — identifiers in doc comments need backticks |
| `must_use_candidate` | 13 | Low — functions returning values should be `#[must_use]` |
| `missing_errors_doc` | 9 | Medium — public fallible functions lack `# Errors` doc section |
| `missing_const_for_fn` | 9 | Low — functions could be `const fn` |
| `missing_panics_doc` | 1 | Medium — public function that can panic lacks `# Panics` doc |
| `cast_possible_truncation` | 1 | Medium — potential data loss in numeric cast |
| `lint_groups_priority` | 2 | Config — lint group priority conflict in Cargo.toml |
| `expect_used` (DENY) | 1 | **Error** — `message.rs:139` uses `.expect()` in production code |

**Total**: 3 errors, 53 warnings. Score: 5/10.

### Complexity Analysis (rust-code-analysis)

| Module | Cyclomatic | Cognitive | MI | SLOC | Verdict |
|--------|-----------|-----------|-----|------|---------|
| `chat/mod.rs` | 100 | 45 | -20.7 | 1,160 | **Critical** — needs decomposition |
| `transport/quic.rs` | 119 | 11 | -23.0 | 1,017 | **High** — large but low cognitive |
| `relay/relay.rs` | 95 | 50 | -10.1 | 740 | **High** — growing handler |
| `chat/room.rs` | 93 | 23 | -13.9 | 919 | **Moderate** — new, room for refactoring |
| `transport/relay.rs` | 82 | 31 | -5.1 | 667 | **Moderate** |

Maintainability Index (MI) is **negative** for top 5 modules — these are technically in the "unmaintainable" range (ideal is >65). This is common for files with many unit tests inline. Score: 5/10.

**Highest complexity functions:**

| Function | Cyclomatic | Cognitive | SLOC |
|----------|-----------|-----------|------|
| `RelayTransport::connect` | 20 | 3 | 110 |
| `ChatManager::receive_one` | 18 | 20 | 148 |
| `RoomManager` (impl block) | 47 | 17 | 313 |
| `ChatManager` (impl block) | 53 | 30 | 432 |
| `App` (impl block) | 52 | 15 | 251 |

### Unwrap/Expect Usage

| Location | Production | Test |
|----------|-----------|------|
| `termchat/src/` | **13** | 263 |
| `termchat-relay/src/` | **2** | 31 |
| `termchat-proto/src/` | **1** | 63 |
| **Total** | **16** | 357 |

**Production unwrap/expect breakdown:**

| Category | Count | Files | Risk |
|----------|-------|-------|------|
| `Mutex::lock().unwrap()` | 5 | `crypto/keys.rs` | **Medium** — Mutex poisoning panics |
| `expect("just-created UUID")` | 1 | `chat/room.rs` | Low — infallible in practice |
| `expect("system clock")` | 2 | `room.rs`, `message.rs` | Low — system clock invariant |
| `expect("unique Arc")` | 1 | `transport/quic.rs` | Low — constructor context |
| `expect("valid bind addr")` | 1 | `transport/quic.rs` | Low — hardcoded string |
| `expect("loop ran at least once")` | 1 | `chat/mod.rs` | Low — logic invariant |
| `expect("room existence checked")` | 1 | `chat/room.rs` | Low — defensive |
| `expect("encoding should not fail")` | 2 | `relay/rooms.rs` | **Medium** — bincode can fail |
| Doc comment examples | 2 | `transport/loopback.rs` | None — doc examples |

Score: 7/10 (test code is fine, production has some fixable cases).

---

## 3. Security & Dependencies: C (62/100)

### cargo-deny Results

| Check | Status | Issues |
|-------|--------|--------|
| Advisories | **FAILED** | 2 unmaintained crates |
| Bans | OK | — |
| Licenses | **FAILED** | 4 crates with unapproved licenses |
| Sources | OK | — |

**Unmaintained advisories:**

| Crate | Advisory | Impact | Alternative |
|-------|----------|--------|-------------|
| **bincode 2.0.1** | RUSTSEC-2025-0141 | All 3 crates | `postcard`, `bitcode`, or `rkyv` |
| **paste 1.0.15** | RUSTSEC-2024-0436 | Transitive via ratatui | `pastey` (drop-in replacement) |

**License gaps** (deny.toml has no `allow` list):

| License | Crates | Fix |
|---------|--------|-----|
| MIT | Most crates (zmij, etc.) | Add `"MIT"` to `[licenses].allow` |
| Apache-2.0 | Many crates | Add `"Apache-2.0"` to `[licenses].allow` |
| Unicode-3.0 | zerotrie, zerovec (ICU) | Add `"Unicode-3.0"` to `[licenses].allow` |

### Duplicate Dependency Versions

| Crate | Versions | Cause |
|-------|----------|-------|
| getrandom | 0.2.17, 0.3.4 | rand 0.8 vs ring |
| rand_core | 0.5.x, 0.6.x | Transitive |
| syn | 1.x, 2.x | Proc-macro ecosystem split |
| hashbrown | 0.14, 0.15 | Transitive |
| bitflags | 1.x, 2.x | Ecosystem transition |
| windows-sys | Multiple | Platform crate fragmentation |
| itertools | 0.12, 0.13 | Transitive |

Score: 5/10 for advisories/licenses, 7/10 for duplicates.

### cargo-geiger (unsafe code)

| Metric | Used/Total |
|--------|-----------|
| Functions | 282/1,337 |
| Expressions | 18,478/65,142 |
| Item impls | 558/683 |
| Item traits | 74/80 |
| Methods | 551/3,412 |

**No unsafe code in TermChat's own crates** — all unsafe is in dependencies (tokio, ring, rustls, quinn, crossterm, etc.). This is expected and acceptable. Score: 9/10.

---

## 4. Wheel Reinvention Check: B+ (85/100)

### Current Crate Choices: Good

| Domain | Current Choice | Verdict |
|--------|---------------|---------|
| Serialization | bincode 2 | Good pattern, but **unmaintained** — migrate to `postcard` or `bitcode` |
| Error handling | thiserror | Correct choice |
| Async runtime | tokio | Correct choice |
| TUI | ratatui + crossterm | Correct choice |
| Crypto | snow (Noise XX) | Correct choice — standard Noise implementation |
| Key exchange | x25519-dalek | Correct choice |
| QUIC | quinn | Correct choice |
| WebSocket | tokio-tungstenite | Correct choice |
| HTTP server | axum | Correct choice |
| UUID | uuid v7 | Correct choice |

### Potential Improvements

| Module | Current | Alternative | Rationale |
|--------|---------|-------------|-----------|
| `codec.rs` (length-prefix framing) | Hand-rolled 4-byte length prefix | `tokio-util::codec::LengthDelimitedCodec` | Standard, battle-tested framing |
| `Mutex<>` in `keys.rs` | `std::sync::Mutex` | `parking_lot::Mutex` or `tokio::sync::Mutex` | parking_lot is non-poisoning; tokio Mutex for async contexts |
| Message timestamps | `SystemTime::now()` | `chrono::Utc::now()` (already a dep) | Already using chrono, inconsistent timestamp sources |
| Room ID generation | `Uuid::now_v7()` | Correct | Good choice — ordered UUIDs |

Score: 8.5/10.

---

## Per-Module Breakdown

| Module | SLOC | Cyclomatic | MI | Unwrap (prod) | Clippy Warns | Grade |
|--------|------|-----------|-----|---------------|-------------|-------|
| `chat/mod.rs` | 1,160 | 100 | -20.7 | 1 | 8 | C |
| `transport/quic.rs` | 1,017 | 119 | -23.0 | 2 | 7 | C+ |
| `chat/room.rs` | 919 | 93 | -13.9 | 2 | 5 | B- |
| `relay/relay.rs` | 740 | 95 | -10.1 | 0 | 4 | B- |
| `chat/history.rs` | 686 | 66 | -1.2 | 0 | 3 | B |
| `transport/relay.rs` | 667 | 82 | -5.1 | 0 | 4 | B |
| `transport/hybrid.rs` | 533 | 51 | 7.4 | 0 | 3 | B+ |
| `proto/message.rs` | 454 | 67 | 8.2 | 1 | 4 | B |
| `relay/rooms.rs` | 444 | 50 | 11.5 | 2 | 3 | B |
| `app.rs` | 344 | 63 | 15.4 | 0 | 3 | B |
| `proto/room.rs` | 342 | 23 | 24.7 | 0 | 2 | A- |
| `crypto/keys.rs` | 299 | 41 | 23.2 | 5 | 2 | C+ |
| `crypto/noise.rs` | 390 | 66 | 11.5 | 0 | 3 | B |
| `transport/loopback.rs` | 209 | 22 | 34.6 | 0 | 1 | A- |
| `proto/codec.rs` | 198 | 27 | 33.8 | 0 | 1 | A |
| `relay/store.rs` | 179 | 22 | 37.2 | 0 | 1 | A |

---

## Top 5 Action Items (Ranked by Impact)

### 1. Migrate off bincode 2 (Impact: HIGH, Effort: M)
**Why**: RUSTSEC-2025-0141 — bincode is permanently unmaintained. This affects all 3 crates.
**Action**: Replace with `postcard` (most similar API, no_std compatible, actively maintained) or `bitcode` (faster, smaller output). Update `termchat-proto/src/codec.rs` encode/decode functions and all `Serialize`/`Deserialize` derives.
**Files**: `Cargo.toml` (workspace deps), `termchat-proto/src/codec.rs`, all test files.

### 2. Fix cargo-deny license allowlist (Impact: HIGH, Effort: S)
**Why**: cargo-deny fails on every check because `[licenses].allow` is empty.
**Action**: Add standard OSS licenses to `termchat/deny.toml`:
```toml
allow = ["MIT", "Apache-2.0", "Apache-2.0 WITH LLVM-exception", "BSD-2-Clause", "BSD-3-Clause", "ISC", "Unicode-3.0", "Zlib"]
```
**Files**: `termchat/deny.toml`

### 3. Fix clippy pedantic/nursery warnings (Impact: MEDIUM, Effort: M)
**Why**: 53 warnings + 3 errors. The `lint_groups_priority` errors and `expect_used` deny need immediate fixing.
**Action**:
- Fix Cargo.toml lint priorities (set groups to priority -1)
- Replace the 1 production `.expect()` in `message.rs:139` with proper error handling
- Add `#[must_use]` annotations (13 instances)
- Fix `doc_markdown` (add backticks around identifiers in doc comments)
- Add `# Errors` sections to public fallible functions
**Files**: `Cargo.toml`, scattered across source files.

### 4. Reduce production unwrap/expect to zero (Impact: MEDIUM, Effort: M)
**Why**: 16 production `unwrap()`/`expect()` calls. The `Mutex::lock().unwrap()` pattern (5 instances in `keys.rs`) will panic on mutex poisoning. The `expect("encoding should not fail")` in `rooms.rs` can theoretically fail.
**Action**:
- Replace `Mutex::lock().unwrap()` with `parking_lot::Mutex` (non-poisoning) or handle `PoisonError`
- Replace encoding `expect()` with `?` error propagation
- Replace `SystemTime` expects with fallible handling
**Files**: `crypto/keys.rs`, `relay/rooms.rs`, `chat/room.rs`, `proto/message.rs`

### 5. Decompose `chat/mod.rs` (Impact: MEDIUM, Effort: L)
**Why**: 1,160 SLOC, cyclomatic complexity 100, cognitive complexity 45, MI of -20.7. This is the most complex module in the codebase. `ChatManager` has a 432-line impl block.
**Action**: Extract into focused modules:
- `chat/manager.rs` — `ChatManager` struct + core send/receive
- `chat/pipeline.rs` — encryption/serialization pipeline
- `chat/events.rs` — `ChatEvent` enum + event handling
- `chat/ack.rs` — delivery acknowledgment tracking
**Files**: `termchat/src/chat/mod.rs` → split into 4 files

---

## LOC Summary

```
                  Files    Code    Comments    Blanks    Total
termchat/src/       20    4,568       209       873     5,650
termchat-relay/src/  4    1,128        52       183     1,363
termchat-proto/src/  6      994        35       222     1,251
                    ─────────────────────────────────────────
Total               30    6,690       296     1,278     8,264
```

**Comment ratio**: 4.4% (low — doc comments are counted but inline comments are sparse)

---

## Comparison to Previous Report

*No previous report found in `./reports/`. This is the baseline.*

---

*Generated by `/code-quality` on 2026-02-07. Next grading recommended after Sprint 6 (UC-007).*
